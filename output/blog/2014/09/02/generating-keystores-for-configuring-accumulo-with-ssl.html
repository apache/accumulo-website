<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/paper/bootstrap.min.css" rel="stylesheet" integrity="sha384-awusxf8AUojygHf2+joICySzB780jVvQaVCAt1clU3QsyAitLGul28Qxb2r1e5g+" crossorigin="anonymous">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/jq-2.2.3/dt-1.10.12/datatables.min.css">
<link href="/css/accumulo.css" rel="stylesheet" type="text/css">

<title>Generating Keystores for configuring Accumulo with SSL</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs/jq-2.2.3/dt-1.10.12/datatables.min.js"></script>
<script>
  // show location of canonical site if not currently on the canonical site
  $(function() {
    var host = window.location.host;
    if (typeof host !== 'undefined' && host !== 'accumulo.apache.org') {
      $('#non-canonical').show();
    }
  });

  $(function() {
    // decorate section headers with anchors
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i class="fa fa-link"></i>';
      if (id) {
        return $el.append($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });

  // fix sidebar width in documentation
  $(function() {
    var $affixElement = $('div[data-spy="affix"]');
    $affixElement.width($affixElement.parent().width());
  });
</script>

</head>
<body style="padding-top: 100px">

  <nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-items">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/"><img id="nav-logo" alt="Apache Accumulo" class="img-responsive" src="/images/accumulo-logo.png" width="200"
        /></a>
    </div>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="nav navbar-nav">
        <li class="nav-link"><a href="/downloads">Download</a></li>
        <li class="nav-link"><a href="/tour">Tour</a></li>
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Releases<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/release/accumulo-2.0.0/">2.0.0 (Latest)</a></li>
            <li><a href="/release/accumulo-1.9.3/">1.9.3</a></li>
            <li><a href="/release/">Archive</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Documentation<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/docs/2.x">User Manual (2.x)</a></li>
            <li><a href="/docs/2.x/apidocs">Javadocs (2.0)</a></li>
            <li><a href="/quickstart-1.x">Quickstart (1.x)</a></li>
            <li><a href="/accumulo2-maven-plugin">Accumulo Maven Plugin</a></li>
            <li><a href="/1.9/accumulo_user_manual.html">User Manual (1.9)</a></li>
            <li><a href="/1.9/apidocs">Javadocs (1.9)</a></li>
            <li><a href="/external-docs">External Docs</a></li>
            <li><a href="/docs-archive/">Archive</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="/contact-us">Contact Us</a></li>
            <li><a href="/how-to-contribute">How To Contribute</a></li>
            <li><a href="/people">People</a></li>
            <li><a href="/related-projects">Related Projects</a></li>
          </ul>
        </li>
        <li class="nav-link"><a href="/search">Search</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#"><img alt="Apache Software Foundation" src="https://www.apache.org/foundation/press/kit/feather.svg" width="15"/><span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="https://www.apache.org">Apache Homepage <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/licenses/">License <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/security">Security <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/foundation/thanks">Thanks <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct <i class="fa fa-external-link"></i></a></li>
            <li><a href="https://www.apache.org/events/current-event.html">Current Event <i class="fa fa-external-link"></i></a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
          Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
        </div>
        <div id="content">
          
          <h1 class="title">Generating Keystores for configuring Accumulo with SSL</h1>
          
          <p>
<b>Author: </b>&nbsp;&nbsp;Josh Elser<br>
<b>Date: </b>&nbsp;&nbsp;02 Sep 2014<br>

</p>

<p>Originally posted at <a href="https://blogs.apache.org/accumulo/entry/generating_keystores_for_configuring_accumulo">https://blogs.apache.org/accumulo/entry/generating_keystores_for_configuring_accumulo</a></p>

<p>One of the major features added in Accumulo 1.6.0 was the ability to configure Accumulo so that the Thrift communications will run over SSL. <a href="http://thrift.apache.org/">Apache Thrift</a> is the remote procedure call library that is leverage for both intra-server communication and client communication with Accumulo. Issuing these calls over a secure socket ensures that unwanted actors cannot inspect the traffic sent across the wire. Given the sometimes sensitive nature of data stored in Accumulo and the authentication details for users, ensuring that no prying eyes have access to these communications is critical.</p>

<p>Due to the complex and deployment specific nature of the security model for some system, Accumulo expects users to provide their own certificates, guaranteeing that they are, in fact, secure. However, for those who want to get security who do not already operate within the confines of an established security infrastructure, OpenSSL and the Java keytool command can be used to generate the necessary components to enable wire encryption.</p>

<p>To enable SSL with Accumulo, it is necessary to generate a certificate authority and certificates which are signed by that authority. Typically, each client and server has its own certificate which provides the finest level of control over a secure cluster when the certificates are properly secured.</p>

<h2 id="generate-a-certificate-authority">Generate a Certificate Authority</h2>

<p>The certificate authority (CA) is what controls what certificates can be used to authenticate with each other. To create a secure connection with two certificates, each certificate must be signed by a certificate authority in the “truststore” (A Java KeyStore which contains at least one Certificate Authority’s public key). When creating your own certificate authority, a single CA is typically sufficient (and would result in a single public key in the truststore). Alternatively, a third party can also act as a certificate authority (to add an additional layer of security); however, these are typically not a free service.</p>

<p>The below is an example of creating a certificate authority and adding its public key to a Java KeyStore to provide to Accumulo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create a private key</span>
openssl genrsa <span class="nt">-des3</span> <span class="nt">-out</span> root.key 4096

<span class="c"># Create a certificate request using the private key</span>
openssl req <span class="nt">-x509</span> <span class="nt">-new</span> <span class="nt">-key</span> root.key <span class="nt">-days</span> 365 <span class="nt">-out</span> root.pem

<span class="c"># Generate a Base64-encoded version of the PEM just created</span>
openssl x509 <span class="nt">-outform</span> der <span class="nt">-in</span> root.pem <span class="nt">-out</span> root.der

<span class="c"># Import the key into a Java KeyStore</span>
keytool <span class="nt">-import</span> <span class="nt">-alias</span> root-key <span class="nt">-keystore</span> truststore.jks <span class="nt">-file</span> root.der

<span class="c"># Remove the DER formatted key file (as we don't need it anymore)</span>
<span class="nb">rm </span>root.der
</code></pre></div></div>

<p>Remember to protect root.key and never distribute it as the private key is the basis for your circle of trust. The keytool command will prompt you about whether or not the certificate should be trusted: enter “yes”. The truststore.jks file, a “truststore”, is meant to be shared with all parties communicating with one another. The password provided to the truststore verifies that the contents of the truststore have not been tampered with.</p>

<h2 id="generate-a-certificatekeystore-per-host">Generate a certificate/keystore per host</h2>

<p>For each host in the system, it’s desirable to generate a certificate. Typically, this corresponds to a certificate per host. Additionally, each client connecting to the Accumulo instance running with SSL should be issued their own certificate. By issuing individual certificates to each entity, it gives proper control to revoke/reissue certificates to clients as necessary, without widespread interruption.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create the private key for our server</span>
openssl genrsa <span class="nt">-out</span> server.key 4096

<span class="c"># Generate a certificate signing request (CSR) with our private key</span>
openssl req <span class="nt">-new</span> <span class="nt">-key</span> server.key <span class="nt">-out</span> server.csr

<span class="c"># Use the CSR and the CA to create a certificate for the server (a reply to the CSR)</span>
openssl x509 <span class="nt">-req</span> <span class="nt">-in</span> server.csr <span class="nt">-CA</span> root.pem <span class="nt">-CAkey</span> root.key <span class="nt">-CAcreateserial</span> <span class="nt">-out</span> server.crt <span class="nt">-days</span> 365

<span class="c"># Use the certificate and the private key for our server to create PKCS12 file</span>
openssl pkcs12 <span class="nt">-export</span> <span class="nt">-in</span> server.crt <span class="nt">-inkey</span> server.key <span class="nt">-certfile</span> server.crt <span class="nt">-name</span> <span class="s1">'server-key'</span> <span class="nt">-out</span> server.p12

<span class="c"># Create a Java KeyStore for the server using the PKCS12 file (private key)</span>
keytool <span class="nt">-importkeystore</span> <span class="nt">-srckeystore</span> server.p12 <span class="nt">-srcstoretype</span> pkcs12 <span class="nt">-destkeystore</span> server.jks <span class="nt">-deststoretype</span> JKS

<span class="c"># Remove the PKCS12 file as we don't need it</span>
<span class="nb">rm </span>server.p12

<span class="c"># Import the CA-signed certificate to the keystore</span>
keytool <span class="nt">-import</span> <span class="nt">-trustcacerts</span> <span class="nt">-alias</span> server-crt <span class="nt">-file</span> server.crt <span class="nt">-keystore</span> server.jks
</code></pre></div></div>

<p>These commands create a private key for the server, generated a certificate signing request created from that private key, used the certificate authority to generate the certificate using the signing request and then created a Java KeyStore with the certificate and the private key for our server. This, paired with the truststore, provide what is needed to configure Accumulo servers to run over SSL. Both the private key (server.key), the certificate signed by the CA (server.pem), and the keystore (server.jks) should be restricted to only be accessed by the user running Accumulo on the host it was generated for. Use chown and chmod to protect the files and do not distribute them over insecure networks.</p>

<h2 id="configure-accumulo-servers">Configure Accumulo Servers</h2>

<p>Now that the Java KeyStores have been created with the necessary information, the Accumulo configuration must be updated so that Accumulo creates the Thrift server over SSL instead of a normal socket. In accumulo-site.xml, configure the following:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>rpc.javax.net.ssl.keyStore<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/path/to/server.jks<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>rpc.javax.net.ssl.keyStorePassword<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>server_password<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>rpc.javax.net.ssl.trustStore<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>/path/to/truststore.jks<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>rpc.javax.net.ssl.trustStorePassword<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>truststore_password<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>instance.rpc.ssl.enabled<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div></div>

<p>The keystore and truststore paths are both absolute paths on the local filesystem (not HDFS). Remember that the server keystore should only be readable by the user running Accumulo and, if you place plaintext passwords in accumulo-site.xml, make sure that accumulo-site.xml is also not globally readable. To keep these passwords out of accumulo-site.xml, consider configuring your system with the new Hadoop CredentialProvider class, see <a href="https://issues.apache.org/jira/browse/ACCUMULO-2464">ACCUMULO-2464</a> for more information which will be available in Accumulo-1.6.1.</p>

<p>Also, be aware that if unique passwords are used for each server when generating the certificate, this will result in different accumulo-site.xml files for each host. Unique configuration files per host will add much complexity to the configuration management of your instance. The use of a CredentialProvider, a feature from Hadoop which allows for acquisitions of passwords from alternate systems) can be used to help alleviate the unique accumulo-site.xml files on each host. A Java KeyStore can be created using the CredentialProvider tools which removes the necessity of passwords to be stored in accumulo-site.xml and can instead point to the CredentialProvider URI which is consistent across hosts.</p>

<h2 id="configure-accumulo-clients">Configure Accumulo Clients</h2>

<p>To configure Accumulo clients, use $HOME/.accumulo/config. This is a simple <a href="http://en.wikipedia.org/wiki/.properties">Java properties file</a>: each line is a configuration, key and value can be separated by a space, and lines beginning with a # symbol are ignored. For example, if we generated a certificate and placed it in a keystore (as described above), we would generate the following file for the Accumulo client.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>instance.rpc.ssl.enabled true
rpc.javax.net.ssl.keyStore  /path/to/client-keystore.jks
rpc.javax.net.ssl.keyStorePassword  client-password
rpc.javax.net.ssl.trustStore  /path/to/truststore.jks
rpc.javax.net.ssl.trustStorePassword  truststore-password
</code></pre></div></div>
<p>When creating a ZooKeeperInstance, the implementation will automatically look for this file and set up a connection with the methods defined in this configuration file. The ClientConfiguration class also contains methods that can be used instead of a configuration file on the filesystem. Again, the paths to the keystore and truststore are on the local filesystem, not HDFS.</p>



<p><strong>View all posts in the <a href="/news">news archive</a></strong></p>

        </div>

        
<footer>

  <p><a href="https://www.apache.org/foundation/contributing"><img src="https://www.apache.org/images/SupportApache-small.png" alt="Support the ASF" id="asf-logo" height="100" /></a></p>

  <p>Copyright © 2011-2020 <a href="https://www.apache.org">The Apache Software Foundation</a>.
Licensed under the <a href="https://www.apache.org/licenses/">Apache License, Version 2.0</a>.</p>

  <p>Apache®, the names of Apache projects and their logos, and the multicolor feather
logo are registered trademarks or trademarks of The Apache Software Foundation
in the United States and/or other countries.</p>

</footer>


      </div>
    </div>
  </div>
</body>
</html>
