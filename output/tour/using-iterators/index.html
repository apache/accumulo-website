<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" type="text/css" href="/css/bootstrap/5.3.3/dist/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="/css/fontawesome/fontawesome-free-6.6.0-web/css/all.css">
<link rel="stylesheet" type="text/css" href="/css/datatables/bs5/dt-2.0.8/datatables.css">
<link rel="stylesheet" type="text/css" href="/css/accumulo.css">

<title>Using Iterators</title>

<script type="text/javascript" src="/js/jquery/3.7.1/jquery.js"></script>
<script type="text/javascript" src="/js/bootstrap/5.3.3/dist/js/bootstrap.bundle.js"></script>
<script type="text/javascript" src="/js/datatables/bs5/dt-2.0.8/datatables.js"></script>
<script type="text/javascript" src="https://www.apachecon.com/event-images/snippet.js"></script>
<script type="text/javascript" src="/js/accumulo.js"></script>
</head>
<body style="padding-top: 100px">

  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img alt="Apache Accumulo" id="nav-logo" src="/images/accumulo-logo.png" width="200">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-items">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
        <li class="nav-item"><a class="nav-link" href="/tour">Tour</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Releases</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/release/accumulo-3.0.0/">3.0.0 (Latest non-LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-2.1.3/">2.1.3 (Latest LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-1.10.4/">1.10.4 (Legacy LTM)</a></li>
            <li><a class="dropdown-item" href="/release/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Documentation</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/docs/2.x">User Manual (2.x)</a></li>
            <li><a class="dropdown-item" href="/docs/2.x/apidocs">Javadocs (2.x)</a></li>
            <li><a class="dropdown-item" href="/api">Public API</a></li>
            <li><a class="dropdown-item" href="/quickstart-1.x">Quickstart (1.x)</a></li>
            <li><a class="dropdown-item" href="/accumulo2-maven-plugin">Accumulo Maven Plugin</a></li>
            <li><a class="dropdown-item" href="/1.10/accumulo_user_manual.html">User Manual (1.10)</a></li>
            <li><a class="dropdown-item" href="/1.10/apidocs">Javadocs (1.10)</a></li>
            <li><a class="dropdown-item" href="/external-docs">External Docs</a></li>
            <li><a class="dropdown-item" href="/docs-archive/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Community</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/contact-us">Contact Us</a></li>
            <li><a class="dropdown-item" href="/how-to-contribute">How To Contribute</a></li>
            <li><a class="dropdown-item" href="/people">People</a></li>
            <li><a class="dropdown-item" href="/related-projects">Related Projects</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/search">Search</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <img alt="Apache Software Foundation" src="https://www.apache.org/foundation/press/kit/feather.svg" width="15"/>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="https://www.apache.org">Apache Homepage <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/licenses/">License <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship">Sponsorship <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/security">Security <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/thanks">Thanks <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/privacy.html">Privacy Policy<span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Current Event <span class="fa-solid fa-up-right-from-square"></span></a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
          Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
        </div>
        <div id="content">
          
          <h1 class="title">Using Iterators</h1>
          
          


<div id="tour-header">
  <h2><a href="/tour/">Accumulo Tour</a>: Using Iterators</h2>
  <p class="text-muted">Tour page 13 of 13</p>
</div>
<div id="tour-content">
  <p>Suppose at the end of each day we record the number of villains a hero has caught that day. Iterators
can assist with this. Iterators are server-side programming mechanisms that allow filtering and
aggregation operations on data during scans and during compactions.</p>

<p>Let’s begin by adding some data for our hero’s recording recent crime-stopping statistics.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; client.tableOperations().create("GothamCrimeStats");

jshell&gt; Mutation mutation1 = new Mutation("id0001");
mutation1 ==&gt; org.apache.accumulo.core.data.Mutation@1
jshell&gt; mutation1.put("hero", "alias", "Batman");

// last three days of Batman's statistics
jshell&gt; mutation1.put("hero", "villainsCaptured", "2");
jshell&gt; mutation1.put("hero", "villainsCaptured", "1");
jshell&gt; mutation1.put("hero", "villainsCaptured", "5");

jshell&gt; Mutation mutation2 = new Mutation("id0002");
mutation2 ==&gt; org.apache.accumulo.core.data.Mutation@1
jshell&gt; mutation2.put("hero", "alias", "Robin");

// last three days of Robin's statistics
jshell&gt; mutation2.put("hero", "villainsCaptured", "1");
jshell&gt; mutation2.put("hero", "villainsCaptured", "0");
jshell&gt; mutation2.put("hero", "villainsCaptured", "2");

jshell&gt; try (BatchWriter writer = client.createBatchWriter("GothamCrimeStats")) {
   ...&gt;   writer.addMutation(mutation1);
   ...&gt;   writer.addMutation(mutation2);
   ...&gt; }
</code></pre></div></div>

<p>Let’s scan to see the data.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; try (ScannerBase scan = client.createScanner("GothamCrimeStats", Authorizations.EMPTY)) {
   ...&gt;   System.out.println("Gotham Police Department Crime Statistics:");
   ...&gt;   for(Map.Entry&lt;Key, Value&gt; entry : scan) {
   ...&gt;     System.out.printf("Key : %-52s  Value : %s\n", entry.getKey(), entry.getValue());
   ...&gt;   }
   ...&gt; }
</code></pre></div></div>

<p>You may notice a problem. We only see the latest entry. That is due to the
<code class="language-plaintext highlighter-rouge">versioningIterator</code> which is applied to all tables by default. It filters out all but the latest entry
when scanning a table.</p>

<p>In order to see a record of past days we can remove the <code class="language-plaintext highlighter-rouge">versioningiterator</code> (you could also choose
a set number of past entries to display). The iterator is named <code class="language-plaintext highlighter-rouge">vers</code>.</p>

<p>To simplify, we will import some additional packages to save some typing.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; import org.apache.accumulo.core.iterators.IteratorUtil.IteratorScope;
jshell&gt; client.tableOperations().removeIterator("GothamCrimeStats", "vers", EnumSet.allOf(IteratorScope.class));
</code></pre></div></div>

<p>Now let’s scan again.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; try (ScannerBase scan = client.createScanner("GothamCrimeStats", Authorizations.EMPTY)) {
   ...&gt;   System.out.println("Gotham Police Department Crime Statistics:");
   ...&gt;   for(Map.Entry&lt;Key, Value&gt; entry : scan) {
   ...&gt;     System.out.printf("Key : %-52s  Value : %s\n", entry.getKey(), entry.getValue());
   ...&gt;   }
   ...&gt; }
Gotham Police Department Crime Statistics:
Key : id0001 hero:alias [] 1654697915769 false              Value : Batman
Key : id0001 hero:villainsCaptured [] 1654697915769 false   Value : 5
Key : id0001 hero:villainsCaptured [] 1654697915769 false   Value : 1
Key : id0001 hero:villainsCaptured [] 1654697915769 false   Value : 2
Key : id0002 hero:alias [] 1654697915769 false              Value : Robin
Key : id0002 hero:villainsCaptured [] 1654697915769 false   Value : 2
Key : id0002 hero:villainsCaptured [] 1654697915769 false   Value : 0
Key : id0002 hero:villainsCaptured [] 1654697915769 false   Value : 1
</code></pre></div></div>

<p>You will now see ALL entries added to the table.</p>

<p>Instead of seeing a daily history, let’s instead keep a running total of captured villains.
A <code class="language-plaintext highlighter-rouge">summingcombiner</code> can be used to accomplish this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; import org.apache.accumulo.core.iterators.user.SummingCombiner;
jshell&gt; import org.apache.accumulo.core.iterators.LongCombiner
</code></pre></div></div>

<p>Create an IteratorSetting object. Set the encoding type and indicate the columns to be summed.
Also, it is a good idea to check for any iterator conflicts prior to attaching the iterator to the
table.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; IteratorSetting scSetting = new IteratorSetting(30, "sum", SummingCombiner.class);
jshell&gt; LongCombiner.setEncodingType(scSetting, LongCombiner.Type.STRING);
jshell&gt; scSetting.addOption("columns", "hero:villainsCaptured");
jshell&gt; client.tableOperations().checkIteratorConflicts("GothamCrimeStats", scSetting, EnumSet.allOf(IteratorScope.class));
jshell&gt; client.tableOperations().attachIterator("GothamCrimeStats", scSetting);
</code></pre></div></div>

<p>Let’s scan again and see what results we get.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; try ( org.apache.accumulo.core.client.Scanner scan = client.createScanner("GothamCrimeStats", Authorizations.EMPTY)) {
   ...&gt;   for(Map.Entry&lt;Key, Value&gt; entry : scan) {
   ...&gt;     System.out.printf("Key : %-52s  Value : %s\n", entry.getKey(), entry.getValue());
   ...&gt;   }
   ...&gt; }
Key : id0001 hero:alias [] 1654699186182 false              Value : Batman
Key : id0001 hero:villainsCaptured [] 1654699186182 false   Value : 8
Key : id0002 hero:alias [] 1654699186182 false              Value : Robin
Key : id0002 hero:villainsCaptured [] 1654699186182 false   Value : 3
</code></pre></div></div>

<p>Adding additional statistics will result in a continual update of the relevant statistic.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jshell&gt; mutation1 = new Mutation("id0001");
jshell&gt; mutation1.put("hero", "villainsCaptured", "4");
jshell&gt; mutation2 = new Mutation("id0002");
jshell&gt; mutation2.put("hero", "villainsCaptured", "2");

jshell&gt; try (BatchWriter writer = client.createBatchWriter("GothamCrimeStats")) {
   ...&gt;   writer.addMutation(mutation1);
   ...&gt;   writer.addMutation(mutation2);
   ...&gt; }

jshell&gt; try ( org.apache.accumulo.core.client.Scanner scan = client.createScanner("GothamCrimeStats", Authorizations.EMPTY)) {
   ...&gt;   for(Map.Entry&lt;Key, Value&gt; entry : scan) {
   ...&gt;     System.out.printf("Key : %-52s  Value : %s\n", entry.getKey(), entry.getValue());
   ...&gt;   }
   ...&gt; }
Key : id0001 hero:alias [] 1654779673027 false              Value : Batman
Key : id0001 hero:villainsCaptured [] 1654780041402 false   Value : 12
Key : id0002 hero:alias [] 1654779673027 false              Value : Robin
Key : id0002 hero:villainsCaptured [] 1654780041402 false   Value : 5
</code></pre></div></div>

</div>

<script>
document.body.onkeyup = function(e){

if (e.keyCode == '37') { window.location = '/tour/conditional-writer-code/'; }



};
</script>

<div class="text-center">
  <h2>
    
    <a href="/tour/conditional-writer-code/">&lt;</a>
    

    13 / 13
    
  </h2>
</div>

        </div>

        
<footer>

  <p><a href="https://www.apache.org/foundation/contributing"><img src="https://www.apache.org/images/SupportApache-small.png" alt="Support the ASF" id="asf-logo" height="100" /></a></p>

  <p>Copyright © 2011-2025 <a href="https://www.apache.org">The Apache Software Foundation</a>.
Licensed under the <a href="https://www.apache.org/licenses/">Apache License, Version 2.0</a>.</p>

  <p>Apache®, the names of Apache projects and their logos, and the multicolor feather
logo are registered trademarks or trademarks of The Apache Software Foundation
in the United States and/or other countries.</p>

</footer>


      </div>
    </div>
  </div>
</body>
</html>
