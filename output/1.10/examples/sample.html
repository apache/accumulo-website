<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" type="text/css" href="/css/bootstrap/5.3.3/dist/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="/css/fontawesome/fontawesome-free-6.6.0-web/css/all.css">
<link rel="stylesheet" type="text/css" href="/css/datatables/bs5/dt-2.0.8/datatables.css">
<link rel="stylesheet" type="text/css" href="/css/accumulo.css">

<title>Apache Accumulo Batch Writing and Scanning Example</title>

<script type="text/javascript" src="/js/jquery/3.7.1/jquery.js"></script>
<script type="text/javascript" src="/js/bootstrap/5.3.3/dist/js/bootstrap.bundle.js"></script>
<script type="text/javascript" src="/js/datatables/bs5/dt-2.0.8/datatables.js"></script>
<script type="text/javascript" src="https://www.apachecon.com/event-images/snippet.js"></script>
<script type="text/javascript" src="/js/accumulo.js"></script>
</head>
<body style="padding-top: 100px">

  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img alt="Apache Accumulo" id="nav-logo" src="/images/accumulo-logo.png" width="200">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-items">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
        <li class="nav-item"><a class="nav-link" href="/tour">Tour</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Releases</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/release/accumulo-3.0.0/">3.0.0 (Latest non-LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-2.1.3/">2.1.3 (Latest LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-1.10.4/">1.10.4 (Legacy LTM)</a></li>
            <li><a class="dropdown-item" href="/release/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Documentation</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/docs/2.x">User Manual (2.x)</a></li>
            <li><a class="dropdown-item" href="/docs/2.x/apidocs">Javadocs (2.x)</a></li>
            <li><a class="dropdown-item" href="/api">Public API</a></li>
            <li><a class="dropdown-item" href="/quickstart-1.x">Quickstart (1.x)</a></li>
            <li><a class="dropdown-item" href="/accumulo2-maven-plugin">Accumulo Maven Plugin</a></li>
            <li><a class="dropdown-item" href="/1.10/accumulo_user_manual.html">User Manual (1.10)</a></li>
            <li><a class="dropdown-item" href="/1.10/apidocs">Javadocs (1.10)</a></li>
            <li><a class="dropdown-item" href="/external-docs">External Docs</a></li>
            <li><a class="dropdown-item" href="/docs-archive/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Community</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/contact-us">Contact Us</a></li>
            <li><a class="dropdown-item" href="/how-to-contribute">How To Contribute</a></li>
            <li><a class="dropdown-item" href="/people">People</a></li>
            <li><a class="dropdown-item" href="/related-projects">Related Projects</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/search">Search</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <img alt="Apache Software Foundation" src="https://www.apache.org/foundation/press/kit/feather.svg" width="15"/>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="https://www.apache.org">Apache Homepage <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/licenses/">License <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship">Sponsorship <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/security">Security <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/thanks">Thanks <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/privacy.html">Privacy Policy<span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Current Event <span class="fa-solid fa-up-right-from-square"></span></a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
          Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
        </div>
        <div id="content">
          
          <h1 class="title">Apache Accumulo Batch Writing and Scanning Example</h1>
          
          <h2 id="basic-sampling-example">Basic Sampling Example</h2>

<p>Accumulo supports building a set of sample data that can be efficiently
accessed by scanners.  What data is included in the sample set is configurable.
Below, some data representing documents are inserted.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; createtable sampex
root@instance sampex&gt; insert 9255 doc content 'abcde'
root@instance sampex&gt; insert 9255 doc url file://foo.txt
root@instance sampex&gt; insert 8934 doc content 'accumulo scales'
root@instance sampex&gt; insert 8934 doc url file://accumulo_notes.txt
root@instance sampex&gt; insert 2317 doc content 'milk, eggs, bread, parmigiano-reggiano'
root@instance sampex&gt; insert 2317 doc url file://groceries/9.txt
root@instance sampex&gt; insert 3900 doc content 'EC2 ate my homework'
root@instance sampex&gt; insert 3900 doc uril file://final_project.txt
</code></pre></div></div>

<p>Below the table sampex is configured to build a sample set.  The configuration
causes Accumulo to include any row where <code class="language-plaintext highlighter-rouge">murmur3_32(row) % 3 ==0</code> in the
tables sample data.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; config -t sampex -s table.sampler.opt.hasher=murmur3_32
root@instance sampex&gt; config -t sampex -s table.sampler.opt.modulus=3
root@instance sampex&gt; config -t sampex -s table.sampler=org.apache.accumulo.core.client.sample.RowSampler
</code></pre></div></div>

<p>Below, attempting to scan the sample returns an error.  This is because data
was inserted before the sample set was configured.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; scan --sample
2015-09-09 12:21:50,643 [shell.Shell] ERROR: org.apache.accumulo.core.client.SampleNotPresentException: Table sampex(ID:2) does not have sampling configured or built
</code></pre></div></div>

<p>To remedy this problem, the following command will flush in memory data and
compact any files that do not contain the correct sample data.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; compact -t sampex --sf-no-sample
</code></pre></div></div>

<p>After the compaction, the sample scan works.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; scan --sample
2317 doc:content []    milk, eggs, bread, parmigiano-reggiano
2317 doc:url []    file://groceries/9.txt
</code></pre></div></div>

<p>The commands below show that updates to data in the sample are seen when
scanning the sample.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; insert 2317 doc content 'milk, eggs, bread, parmigiano-reggiano, butter'
root@instance sampex&gt; scan --sample
2317 doc:content []    milk, eggs, bread, parmigiano-reggiano, butter
2317 doc:url []    file://groceries/9.txt
</code></pre></div></div>

<p>Inorder to make scanning the sample fast, sample data is partitioned as data is
written to Accumulo.  This means if the sample configuration is changed, that
data written previously is partitioned using a different criteria.  Accumulo
will detect this situation and fail sample scans.  The commands below show this
failure and fixiing the problem with a compaction.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; config -t sampex -s table.sampler.opt.modulus=2
root@instance sampex&gt; scan --sample
2015-09-09 12:22:51,058 [shell.Shell] ERROR: org.apache.accumulo.core.client.SampleNotPresentException: Table sampex(ID:2) does not have sampling configured or built
root@instance sampex&gt; compact -t sampex --sf-no-sample
2015-09-09 12:23:07,242 [shell.Shell] INFO : Compaction of table sampex started for given range
root@instance sampex&gt; scan --sample
2317 doc:content []    milk, eggs, bread, parmigiano-reggiano
2317 doc:url []    file://groceries/9.txt
3900 doc:content []    EC2 ate my homework
3900 doc:uril []    file://final_project.txt
9255 doc:content []    abcde
9255 doc:url []    file://foo.txt
</code></pre></div></div>

<p>The example above is replicated in a java program using the Accumulo API.
Below is the program name and the command to run it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/accumulo org.apache.accumulo.examples.simple.sample.SampleExample -i instance -z localhost -u root -p secret
</code></pre></div></div>

<p>The commands below look under the hood to give some insight into how this
feature works.  The commands determine what files the sampex table is using.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance sampex&gt; tables -l
accumulo.metadata    =&gt;        !0
accumulo.replication =&gt;      +rep
accumulo.root        =&gt;        +r
sampex               =&gt;         2
trace                =&gt;         1
root@instance sampex&gt; scan -t accumulo.metadata -c file -b 2 -e 2&lt;
2&lt; file:hdfs://localhost:10000/accumulo/tables/2/default_tablet/A000000s.rf []    702,8
</code></pre></div></div>

<p>Below shows running <code class="language-plaintext highlighter-rouge">accumulo rfile-info</code> on the file above.  This shows the
rfile has a normal default locality group and a sample default locality group.
The output also shows the configuration used to create the sample locality
group.  The sample configuration within an RFile must match the tables sample
configuration for sample scan to work.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bin/accumulo rfile-info hdfs://localhost:10000/accumulo/tables/2/default_tablet/A000000s.rf
Reading file: hdfs://localhost:10000/accumulo/tables/2/default_tablet/A000000s.rf
RFile Version            : 8

Locality group           : &lt;DEFAULT&gt;
  Start block            : 0
  Num   blocks           : 1
  Index level 0          : 35 bytes  1 blocks
  First key              : 2317 doc:content [] 1437672014986 false
  Last key               : 9255 doc:url [] 1437672014875 false
  Num entries            : 8
  Column families        : [doc]

Sample Configuration     :
  Sampler class          : org.apache.accumulo.core.client.sample.RowSampler
  Sampler options        : {hasher=murmur3_32, modulus=2}

Sample Locality group    : &lt;DEFAULT&gt;
  Start block            : 0
  Num   blocks           : 1
  Index level 0          : 36 bytes  1 blocks
  First key              : 2317 doc:content [] 1437672014986 false
  Last key               : 9255 doc:url [] 1437672014875 false
  Num entries            : 6
  Column families        : [doc]

Meta block     : BCFile.index
  Raw size             : 4 bytes
  Compressed size      : 12 bytes
  Compression type     : gz

Meta block     : RFile.index
  Raw size             : 309 bytes
  Compressed size      : 176 bytes
  Compression type     : gz
</code></pre></div></div>

<h2 id="shard-sampling-example">Shard Sampling Example</h2>

<p><code class="language-plaintext highlighter-rouge">README.shard</code> shows how to index and search files using Accumulo.  That
example indexes documents into a table named <code class="language-plaintext highlighter-rouge">shard</code>.  The indexing scheme used
in that example places the document name in the column qualifier.  A useful
sample of this indexing scheme should contain all data for any document in the
sample.   To accomplish this, the following commands build a sample for the
shard table based on the column qualifier.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@instance shard&gt; config -t shard -s table.sampler.opt.hasher=murmur3_32
root@instance shard&gt; config -t shard -s table.sampler.opt.modulus=101
root@instance shard&gt; config -t shard -s table.sampler.opt.qualifier=true
root@instance shard&gt; config -t shard -s table.sampler=org.apache.accumulo.core.client.sample.RowColumnSampler
root@instance shard&gt; compact -t shard --sf-no-sample -w
2015-07-23 15:00:09,280 [shell.Shell] INFO : Compacting table ...
2015-07-23 15:00:10,134 [shell.Shell] INFO : Compaction of table shard completed for given range
</code></pre></div></div>

<p>After enabling sampling, the command below counts the number of documents in
the sample containing the words <code class="language-plaintext highlighter-rouge">import</code> and <code class="language-plaintext highlighter-rouge">int</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bin/accumulo org.apache.accumulo.examples.simple.shard.Query --sample -i instance16 -z localhost -t shard -u root -p secret import int | fgrep '.java' | wc
     11      11    1246
</code></pre></div></div>

<p>The command below counts the total number of documents containing the words
<code class="language-plaintext highlighter-rouge">import</code> and <code class="language-plaintext highlighter-rouge">int</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bin/accumulo org.apache.accumulo.examples.simple.shard.Query -i instance16 -z localhost -t shard -u root -p secret import int | fgrep '.java' | wc
   1085    1085  118175
</code></pre></div></div>

<p>The counts 11 out of 1085 total are around what would be expected for a modulus
of 101.  Querying the sample first provides a quick way to estimate how much data
the real query will bring back.</p>

<p>Another way sample data could be used with the shard example is with a
specialized iterator.  In the examples source code there is an iterator named
CutoffIntersectingIterator.  This iterator first checks how many documents are
found in the sample data.  If too many documents are found in the sample data,
then it returns nothing.   Otherwise it proceeds to query the full data set.
To experiment with this iterator, use the following command.  The
<code class="language-plaintext highlighter-rouge">--sampleCutoff</code> option below will cause the query to return nothing if based
on the sample it appears a query would return more than 1000 documents.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./bin/accumulo org.apache.accumulo.examples.simple.shard.Query --sampleCutoff 1000 -i instance16 -z localhost -t shard -u root -p secret import int | fgrep '.java' | wc
</code></pre></div></div>

        </div>

        
<footer>

  <p><a href="https://www.apache.org/foundation/contributing"><img src="https://www.apache.org/images/SupportApache-small.png" alt="Support the ASF" id="asf-logo" height="100" /></a></p>

  <p>Copyright © 2011-2025 <a href="https://www.apache.org">The Apache Software Foundation</a>.
Licensed under the <a href="https://www.apache.org/licenses/">Apache License, Version 2.0</a>.</p>

  <p>Apache®, the names of Apache projects and their logos, and the multicolor feather
logo are registered trademarks or trademarks of The Apache Software Foundation
in the United States and/or other countries.</p>

</footer>


      </div>
    </div>
  </div>
</body>
</html>
