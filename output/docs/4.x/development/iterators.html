<!DOCTYPE html>
<html lang="en">
<head>
<!--
    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" type="text/css" href="/css/bootstrap/5.3.3/dist/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="/css/fontawesome/fontawesome-free-6.6.0-web/css/all.css">
<link rel="stylesheet" type="text/css" href="/css/datatables/bs5/dt-2.0.8/datatables.css">
<link rel="stylesheet" type="text/css" href="/css/accumulo.css">

<title>Accumulo Documentation - Iterators</title>

<script type="text/javascript" src="/js/jquery/3.7.1/jquery.js"></script>
<script type="text/javascript" src="/js/bootstrap/5.3.3/dist/js/bootstrap.bundle.js"></script>
<script type="text/javascript" src="/js/datatables/bs5/dt-2.0.8/datatables.js"></script>
<script type="text/javascript" src="https://www.apachecon.com/event-images/snippet.js"></script>
<script type="text/javascript" src="/js/accumulo.js"></script>
</head>
<body style="padding-top: 100px">

  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img alt="Apache Accumulo" id="nav-logo" src="/images/accumulo-logo.png" width="200">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-items">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar-items">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
        <li class="nav-item"><a class="nav-link" href="/tour">Tour</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Releases</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/release/accumulo-3.0.0/">3.0.0 (Latest non-LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-2.1.3/">2.1.3 (Latest LTM)</a></li>
            <li><a class="dropdown-item" href="/release/accumulo-1.10.4/">1.10.4 (Legacy LTM)</a></li>
            <li><a class="dropdown-item" href="/release/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Documentation</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/docs/2.x">User Manual (2.x)</a></li>
            <li><a class="dropdown-item" href="/docs/2.x/apidocs">Javadocs (2.x)</a></li>
            <li><a class="dropdown-item" href="/api">Public API</a></li>
            <li><a class="dropdown-item" href="/quickstart-1.x">Quickstart (1.x)</a></li>
            <li><a class="dropdown-item" href="/accumulo2-maven-plugin">Accumulo Maven Plugin</a></li>
            <li><a class="dropdown-item" href="/1.10/accumulo_user_manual.html">User Manual (1.10)</a></li>
            <li><a class="dropdown-item" href="/1.10/apidocs">Javadocs (1.10)</a></li>
            <li><a class="dropdown-item" href="/external-docs">External Docs</a></li>
            <li><a class="dropdown-item" href="/docs-archive/">Archive</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Community</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/contact-us">Contact Us</a></li>
            <li><a class="dropdown-item" href="/how-to-contribute">How To Contribute</a></li>
            <li><a class="dropdown-item" href="/people">People</a></li>
            <li><a class="dropdown-item" href="/related-projects">Related Projects</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="/search">Search</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <img alt="Apache Software Foundation" src="https://www.apache.org/foundation/press/kit/feather.svg" width="15"/>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="https://www.apache.org">Apache Homepage <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/licenses/">License <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship">Sponsorship <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/security">Security <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/thanks">Thanks <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct <span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/foundation/policies/privacy.html">Privacy Policy<span class="fa-solid fa-up-right-from-square"></span></a></li>
            <li><a class="dropdown-item" href="https://www.apache.org/events/current-event.html">Current Event <span class="fa-solid fa-up-right-from-square"></span></a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <div id="non-canonical" style="display: none; background-color: #F0E68C; padding-left: 1em;">
          Visit the official site at: <a href="https://accumulo.apache.org">https://accumulo.apache.org</a>
        </div>
        <div id="content">
          
          <div class="alert alert-danger" style="margin-bottom: 0px;" role="alert">
  This is a <strong>draft</strong> user guide for a future release of Accumulo 4.0.0!<br>
</div>

<div class="row">
  <div class="col-md-3">
    <div class="accordion sticky-top" id="myAccordion" style="top: 100px;">
      
      
      
        
          
        
          
        
          
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headinggetting-started">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsegetting-started" aria-expanded="false" aria-controls="collapsegetting-started">
                  Getting started
                </button>
              </div>
              <div id="collapsegetting-started" class="accordion-collapse collapse" aria-labelledby="headinggetting-started" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row"><a href="/docs/4.x/getting-started/quickstart">Setup</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/design">Design</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/features">Features</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/clients">Accumulo Clients</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/shell">Accumulo Shell</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/table_design">Table Design</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/table_configuration">Table Configuration</a></div>
                  
                    <div class="row"><a href="/docs/4.x/getting-started/glossary">Glossary</a></div>
                  
                </div>
              </div>
            </div>
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headingdevelopment">
                <button class="accordion-button " type="button" data-bs-toggle="collapse" data-bs-target="#collapsedevelopment" aria-expanded="true" aria-controls="collapsedevelopment">
                  Development
                </button>
              </div>
              <div id="collapsedevelopment" class="accordion-collapse collapse show" aria-labelledby="headingdevelopment" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row selected"><a href="/docs/4.x/development/iterators">Iterators</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/mapreduce">MapReduce</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/spark">Spark</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/development_tools">Development Tools</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/sampling">Sampling</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/summaries">Summary Statistics</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/proxy">Proxy</a></div>
                  
                    <div class="row"><a href="/docs/4.x/development/high_speed_ingest">High-Speed Ingest</a></div>
                  
                </div>
              </div>
            </div>
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headingsecurity">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsesecurity" aria-expanded="false" aria-controls="collapsesecurity">
                  Security
                </button>
              </div>
              <div id="collapsesecurity" class="accordion-collapse collapse" aria-labelledby="headingsecurity" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row"><a href="/docs/4.x/security/overview">Security Overview</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/authentication">Authentication</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/permissions">Permissions</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/authorizations">Authorizations</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/on-disk-encryption">On Disk Encryption</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/wire-encryption">Wire Encryption</a></div>
                  
                    <div class="row"><a href="/docs/4.x/security/kerberos">Kerberos</a></div>
                  
                </div>
              </div>
            </div>
          
        
          
        
      
        
          
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headingconfiguration">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseconfiguration" aria-expanded="false" aria-controls="collapseconfiguration">
                  Configuration
                </button>
              </div>
              <div id="collapseconfiguration" class="accordion-collapse collapse" aria-labelledby="headingconfiguration" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row"><a href="/docs/4.x/configuration/overview">Configuration Overview</a></div>
                  
                    <div class="row"><a href="/docs/4.x/configuration/files">Configuration Files</a></div>
                  
                    <div class="row"><a href="/docs/4.x/configuration/client-properties">Client Properties (4.x)</a></div>
                  
                    <div class="row"><a href="/docs/4.x/configuration/server-properties">Server Properties (4.x)</a></div>
                  
                    <div class="row"><a href="/docs/4.x/configuration/metrics">Metrics Documentation (4.x)</a></div>
                  
                </div>
              </div>
            </div>
          
        
          
        
          
        
          
        
          
        
          
        
      
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headingadministration">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseadministration" aria-expanded="false" aria-controls="collapseadministration">
                  Administration
                </button>
              </div>
              <div id="collapseadministration" class="accordion-collapse collapse" aria-labelledby="headingadministration" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row"><a href="/docs/4.x/administration/in-depth-install">In-depth Installation</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/monitoring-metrics">Monitoring & Metrics</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/fate">FATE</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/multivolume">Multi-Volume Installations</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/replication">Replication</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/caching">Caching</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/compaction">Compactions</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/merging">Merging</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/upgrading">Upgrading Accumulo</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/scan-executors">Scan Executors</a></div>
                  
                    <div class="row"><a href="/docs/4.x/administration/erasure-coding">Erasure Coding</a></div>
                  
                </div>
              </div>
            </div>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <div class="accordion-item">
              <div class="accordion-header fs-5 fw-bold" id="headingtroubleshooting">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsetroubleshooting" aria-expanded="false" aria-controls="collapsetroubleshooting">
                  Troubleshooting
                </button>
              </div>
              <div id="collapsetroubleshooting" class="accordion-collapse collapse" aria-labelledby="headingtroubleshooting" data-bs-parent="#myAccordion">
                <div class="accordion-body">
                  
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/basic">Basic Troubleshooting</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/advanced">Advanced Troubleshooting</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/tools">Troubleshooting Tools</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/system-metadata-tables">System Metadata Tables</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/performance">Performance</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/tracing">Tracing</a></div>
                  
                    <div class="row"><a href="/docs/4.x/troubleshooting/zookeeper">ZooKeeper</a></div>
                  
                </div>
              </div>
            </div>
          
        
      
    </div>
  </div>
  <div class="col-md-9">
    
    <p>Accumulo 4.x Documentation &gt;&gt; Development &gt;&gt; Iterators</p>
    
    
    <div class="row mt-4">
      <div class="col-md-12 d-flex justify-content-between">
        <h1>Iterators</h1>
        <a href="https://github.com/apache/accumulo-website/edit/main/_docs-4/development/iterators.md" role="button"><span class="fa-solid fa-pen-to-square"></span> <small>Edit this page</small></a>
      </div>
    </div>
    
    <p>Accumulo <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/SortedKeyValueIterator.html">SortedKeyValueIterators</a>, commonly referred to as <strong>Iterators</strong> for short, are server-side programming constructs
that allow users to implement custom retrieval or computational purpose within Accumulo TabletServers.  The name rightly
brings forward similarities to the Java Iterator interface; however, Accumulo Iterators are more complex than Java
Iterators. Notably, in addition to the expected methods to retrieve the current element and advance to the next element
in the iteration, Accumulo Iterators must also support the ability to “move” (<code class="language-plaintext highlighter-rouge">seek</code>) to a specified point in the
iteration (the Accumulo table). Accumulo Iterators are designed to be concatenated together, similar to applying a
series of transformations to a list of elements. Accumulo Iterators can duplicate their underlying source to create
multiple “pointers” over the same underlying data (which is extremely powerful since each stream is sorted) or they can
merge multiple Iterators into a single view. In this sense, a collection of Iterators operating in tandem is closer to
a tree-structure than a list, but there is always a sense of a flow of Key-Value pairs through some Iterators. Iterators
are not designed to act as triggers nor are they designed to operate outside of the purview of a single table.</p>

<p>This guide aims to provide a more detailed description of how Iterators are invoked, some best practices and some common
pitfalls.</p>

<h2 id="instantiation">Instantiation</h2>

<p>To invoke an Accumulo Iterator inside of the TabletServer, the Iterator class must be on the classpath of every
TabletServer. It is common to place a JAR file which contains the Iterator in <code class="language-plaintext highlighter-rouge">lib/</code>. Accumulo references the Iterator class by name and uses Java reflection to instantiate the Iterator. This means that Iterators must have a public no-args constructor.</p>

<h2 id="interface">Interface</h2>

<p>A normal implementation of the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/SortedKeyValueIterator.html">SortedKeyValueIterator</a> defines functionality for the following methods:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">SortedKeyValueIterator</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">,</span><span class="nc">Value</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">options</span><span class="o">,</span> <span class="nc">IteratorEnvironment</span> <span class="n">env</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

<span class="kt">boolean</span> <span class="nf">hasTop</span><span class="o">();</span>

<span class="kt">void</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

<span class="kt">void</span> <span class="nf">seek</span><span class="o">(</span><span class="nc">Range</span> <span class="n">range</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ByteSequence</span><span class="o">&gt;</span> <span class="n">columnFamilies</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">inclusive</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

<span class="nc">Key</span> <span class="nf">getTopKey</span><span class="o">();</span>

<span class="nc">Value</span> <span class="nf">getTopValue</span><span class="o">();</span>

<span class="nc">SortedKeyValueIterator</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">,</span><span class="nc">Value</span><span class="o">&gt;</span> <span class="nf">deepCopy</span><span class="o">(</span><span class="nc">IteratorEnvironment</span> <span class="n">env</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="init">init</h3>

<p>The <code class="language-plaintext highlighter-rouge">init</code> method is called by the TabletServer after it constructs an instance of the Iterator.  This method should
clear/reset any internal state in the Iterator and prepare it to process data.  The first argument, the <code class="language-plaintext highlighter-rouge">source</code>, is the
Iterator “below” this Iterator (where the client is at “top” and the Iterator for files in HDFS are at the “bottom”).
The “source” Iterator provides the Key-Value pairs which this Iterator will operate upon.</p>

<p>The second argument, a Map of options, is made up of options provided by the user, options set in the table’s
configuration, and/or options set in the containing namespace’s configuration.
These options allow for Iterators to dynamically configure themselves on the fly. If no options are used in the current context
(a Scan or Compaction), the Map will be empty. An example of a configuration item for an Iterator could be a pattern used to filter
Key-Value pairs in a regular expression Iterator.</p>

<p>The third argument, the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/IteratorEnvironment.html">IteratorEnvironment</a>, is a special object which provides information to this Iterator about the
context in which it was invoked. Commonly, this information is not necessary to inspect. For example, if an Iterator
knows that it is running in the context of a full-major compaction (reading all of the data) as opposed to a user scan
(which may strongly limit the number of columns), the Iterator might make different algorithmic decisions in an attempt to
optimize itself.</p>

<h3 id="seek">seek</h3>

<p>The purpose of the seek method is to advance the stream of Key-Value pairs to a certain point in the iteration (the Accumulo table). It is common that before
the implementation of this method returns some additional processing is performed which may further advance the current
position past the <code class="language-plaintext highlighter-rouge">startKey</code> of the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a>. This, however, is dependent on the functionality the iterator provides. For
example, a filtering iterator would consume a number Key-Value pairs which do not meet its criteria before <code class="language-plaintext highlighter-rouge">seek</code>
returns. The important condition for <code class="language-plaintext highlighter-rouge">seek</code> to meet is that this Iterator should be ready to return the first Key-Value
pair, or none if no such pair is available, when the method returns. The Key-Value pair would be returned by <code class="language-plaintext highlighter-rouge">getTopKey</code>
and <code class="language-plaintext highlighter-rouge">getTopValue</code>, respectively, and <code class="language-plaintext highlighter-rouge">hasTop</code> should return a boolean denoting whether or not there is
a Key-Value pair to return.</p>

<p>The arguments passed to seek are as follows:</p>

<p>The TabletServer first provides a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a>, an object which defines some collection of Accumulo <code class="language-plaintext highlighter-rouge">Key</code>s, which defines the
Key-Value pairs that this Iterator should return. Each <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> has a <code class="language-plaintext highlighter-rouge">startKey</code> and <code class="language-plaintext highlighter-rouge">endKey</code> with an inclusive flag for
both. While this Range is often similar to the Range(s) set by the client on a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/Scanner.html">Scanner</a> or <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/BatchScanner.html">BatchScanner</a>, it is not
guaranteed to be a Range that the client set. Accumulo will split up larger ranges and group them together based on
Tablet boundaries per TabletServer. Iterators should not attempt to implement any custom logic based on the Range(s)
provided to <code class="language-plaintext highlighter-rouge">seek</code> and Iterators should not return any Keys that fall outside of the provided Range.</p>

<p>The second argument, a <code class="language-plaintext highlighter-rouge">Collection&lt;ByteSequence&gt;</code>, is the set of column families which should be retained or
excluded by this Iterator. The third argument, a boolean, defines whether the collection of column families
should be treated as an inclusion collection (true) or an exclusion collection (false).</p>

<p>It is likely that all implementations of <code class="language-plaintext highlighter-rouge">seek</code> will first make a call to the <code class="language-plaintext highlighter-rouge">seek</code> method on the
“source” Iterator that was provided in the <code class="language-plaintext highlighter-rouge">init</code> method. The collection of column families and
the boolean <code class="language-plaintext highlighter-rouge">include</code> argument should be passed down as well as the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a>. Somewhat commonly, the Iterator will
also implement some sort of additional logic to find or compute the first Key-Value pair in the provided
Range. For example, a regular expression Iterator would consume all records which do not match the given
pattern before returning from <code class="language-plaintext highlighter-rouge">seek</code>.</p>

<p>It is important to retain the original <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> passed to this method to know when this Iterator should stop
reading more Key-Value pairs. Ignoring this typically does not affect scans from a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/Scanner.html">Scanner</a>, but it
will result in duplicate keys emitting from a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/BatchScanner.html">BatchScanner</a> if the scanned table has more than one tablet.
Best practice is to never emit entries outside the seek range.</p>

<h3 id="next">next</h3>

<p>The <code class="language-plaintext highlighter-rouge">next</code> method is analogous to the <code class="language-plaintext highlighter-rouge">next</code> method on a Java Iterator: this method should advance
the Iterator to the next Key-Value pair. For implementations that perform some filtering or complex
logic, this may result in more than one Key-Value pair being inspected. This method alters
some internal state that is exposed via the <code class="language-plaintext highlighter-rouge">hasTop</code>, <code class="language-plaintext highlighter-rouge">getTopKey</code>, and <code class="language-plaintext highlighter-rouge">getTopValue</code> methods.</p>

<p>The result of this method is commonly caching a Key-Value pair which <code class="language-plaintext highlighter-rouge">getTopKey</code> and <code class="language-plaintext highlighter-rouge">getTopValue</code>
can later return. While there is another Key-Value pair to return, <code class="language-plaintext highlighter-rouge">hasTop</code> should return true.
If there are no more Key-Value pairs to return from this Iterator since the last call to
<code class="language-plaintext highlighter-rouge">seek</code>, <code class="language-plaintext highlighter-rouge">hasTop</code> should return false.</p>

<h3 id="hastop">hasTop</h3>

<p>The <code class="language-plaintext highlighter-rouge">hasTop</code> method is similar to the <code class="language-plaintext highlighter-rouge">hasNext</code> method on a Java Iterator in that it informs
the caller if there is a Key-Value pair to be returned. If there is no pair to return, this method
should return false. Like a Java Iterator, multiple calls to <code class="language-plaintext highlighter-rouge">hasTop</code> (without calling <code class="language-plaintext highlighter-rouge">next</code>) should not
alter the internal state of the Iterator.</p>

<h3 id="gettopkey-and-gettopvalue">getTopKey and getTopValue</h3>

<p>These methods simply return the current Key-Value pair for this iterator. If <code class="language-plaintext highlighter-rouge">hasTop</code> returns true,
both of these methods should return non-null objects. If <code class="language-plaintext highlighter-rouge">hasTop</code> returns false, it is undefined
what these methods should return. Like <code class="language-plaintext highlighter-rouge">hasTop</code>, multiple calls to these methods should not alter
the state of the Iterator.</p>

<p>Users should take caution when either</p>

<ol>
  <li>caching the Key/Value from <code class="language-plaintext highlighter-rouge">getTopKey</code>/<code class="language-plaintext highlighter-rouge">getTopValue</code>, for use after calling <code class="language-plaintext highlighter-rouge">next</code> on the source iterator.
In this case, the cached Key/Value object is aliased to the reference returned by the source iterator.
Iterators may reuse the same Key/Value object in a <code class="language-plaintext highlighter-rouge">next</code> call for performance reasons, changing the data
that the cached Key/Value object references and resulting in a logic bug.</li>
  <li>modifying the Key/Value from <code class="language-plaintext highlighter-rouge">getTopKey</code>/<code class="language-plaintext highlighter-rouge">getTopValue</code>. If the source iterator reuses data stored in the Key/Value,
then the source iterator may use the modified data that the Key/Value references. This may/may not result in a logic bug.</li>
</ol>

<p>In both cases, copying the Key/Value’s data into a new object ensures iterator correctness. If neither case applies,
it is safe to not copy the Key/Value.  The general guideline is to be aware of who else may use Key/Value objects
returned from <code class="language-plaintext highlighter-rouge">getTopKey</code>/<code class="language-plaintext highlighter-rouge">getTopValue</code>.</p>

<h3 id="deepcopy">deepCopy</h3>

<p>The <code class="language-plaintext highlighter-rouge">deepCopy</code> method is similar to the <code class="language-plaintext highlighter-rouge">clone</code> method from the Java <code class="language-plaintext highlighter-rouge">Cloneable</code> interface.
Implementations of this method should return a new object of the same type as the Accumulo Iterator
instance it was called on. Any internal state from the instance <code class="language-plaintext highlighter-rouge">deepCopy</code> was called
on should be carried over to the returned copy. The returned copy should be ready to have
<code class="language-plaintext highlighter-rouge">seek</code> called on it. The <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/SortedKeyValueIterator.html">SortedKeyValueIterator</a> interface guarantees that <code class="language-plaintext highlighter-rouge">init</code> will be called on
an iterator before <code class="language-plaintext highlighter-rouge">deepCopy</code> and that <code class="language-plaintext highlighter-rouge">init</code> will not be called on the iterator returned by
<code class="language-plaintext highlighter-rouge">deepCopy</code>.</p>

<p>Typically, implementations of <code class="language-plaintext highlighter-rouge">deepCopy</code> call a copy-constructor which will initialize
internal data structures. As with <code class="language-plaintext highlighter-rouge">seek</code>, it is common for the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/IteratorEnvironment.html">IteratorEnvironment</a>
argument to be ignored as most Iterator implementations can be written without the explicit
information the environment provides.</p>

<p>In the analogy of a series of Iterators representing a tree, <code class="language-plaintext highlighter-rouge">deepCopy</code> can be thought of as
early programming assignments which implement their own tree data structures. <code class="language-plaintext highlighter-rouge">deepCopy</code> calls
copy on its sources (the children), copies itself, attaches the copies of the children, and
then returns itself.</p>

<h2 id="yielding-interface">Yielding Interface</h2>

<p>If you have implemented an iterator with a next or seek call that can take a very long time
resulting in starving out other scans within the same thread pool, try implementing the
optional YieldingKeyValueIterator interface which SortedKeyValueIterator extends.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">default</span> <span class="kt">void</span> <span class="nf">enableYielding</span><span class="o">(</span><span class="nc">YieldCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</code></pre></div></div>

<h3 id="enableyielding">enableYielding</h3>

<p>The implementation of this method should simply cache the supplied callback as a member of
the iterator. Then one can call the yield(Key key) method on the callback within a next or
seek call when the iterator is to yield control.  The supplied key will be used as the
start key in a follow-on seek call’s range allowing the iterator to continue where it left
off. Note when an iterator yields, the hasTop() method must return false.  Also note that
the enableYielding method will not be called in isolation mode.</p>

<h2 id="tabletserver-invocation-of-iterators">TabletServer invocation of Iterators</h2>

<p>The following code is a general outline for how TabletServers invoke Iterators.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">KeyValue</span><span class="o">&gt;</span> <span class="n">batch</span><span class="o">;</span>
<span class="nc">Range</span> <span class="n">range</span> <span class="o">=</span> <span class="n">getRangeFromClient</span><span class="o">();</span>
<span class="k">while</span> <span class="o">(!</span><span class="n">overSizeLimit</span><span class="o">(</span><span class="n">batch</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">SortedKeyValueIterator</span> <span class="n">source</span> <span class="o">=</span> <span class="n">getSystemIterator</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">clzName</span> <span class="o">:</span> <span class="n">getUserIterators</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">clzName</span><span class="o">);</span>
        <span class="nc">SortedKeyValueIterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SortedKeyValueIterator</span><span class="o">)</span> <span class="n">clz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">iter</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">opts</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">iter</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// read a batch of data to return to client from</span>
    <span class="c1">// the last iterator, the "top"</span>
    <span class="nc">SortedKeyValueIterator</span> <span class="n">topIter</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>

    <span class="nc">YieldCallback</span> <span class="n">cb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">YieldCallback</span><span class="o">();</span>
    <span class="n">topIter</span><span class="o">.</span><span class="na">enableYielding</span><span class="o">(</span><span class="n">cb</span><span class="o">)</span>

    <span class="n">topIter</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">range</span><span class="o">,</span> <span class="o">...)</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">topIter</span><span class="o">.</span><span class="na">hasTop</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">overSizeLimit</span><span class="o">(</span><span class="n">batch</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">topIter</span><span class="o">.</span><span class="na">getTopKey</span><span class="o">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">topIter</span><span class="o">.</span><span class="na">getTopValue</span><span class="o">()</span>
        <span class="n">batch</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">KeyValue</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">)</span>
        <span class="c1">// remember the last key returned</span>
        <span class="n">setLastKeyReturned</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">systemDataSourcesChanged</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// code does not show isolation case, which will</span>
            <span class="c1">// keep using same data sources until a row boundary is hit</span>
            <span class="n">range</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Range</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">range</span><span class="o">.</span><span class="na">endKey</span><span class="o">(),</span> <span class="n">range</span><span class="o">.</span><span class="na">endKeyInclusive</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">topIter</span><span class="o">.</span><span class="na">next</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">hasYielded</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// remember the yield key as the last key returned</span>
        <span class="n">setLastKeyReturned</span><span class="o">(</span><span class="n">cb</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//return batch of key values to client</span>
</code></pre></div></div>

<p>Additionally, the obtuse “re-seek” case can be outlined as the following:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Given the above</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">KeyValue</span><span class="o">&gt;</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">getNextBatch</span><span class="o">();</span>

<span class="c1">// thread goes away (client stops asking for the next batch).</span>

<span class="c1">// Eventually client comes back</span>
<span class="c1">// Setup as before...</span>
<span class="nc">Range</span> <span class="n">userRange</span> <span class="o">=</span> <span class="n">getRangeFromClient</span><span class="o">();</span>
<span class="nc">Range</span> <span class="n">actualRange</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Range</span><span class="o">(</span><span class="n">getLastKeyReturned</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="n">userRange</span><span class="o">.</span><span class="na">getEndKey</span><span class="o">(),</span> <span class="n">userRange</span><span class="o">.</span><span class="na">isEndKeyInclusive</span><span class="o">());</span>

<span class="c1">// Use the actualRange, not the user provided one</span>
<span class="n">topIter</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">actualRange</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="isolation">Isolation</h2>

<p>Accumulo provides a feature which clients can enable to prevent the viewing of partially
applied mutations within the context of rows. If a client is submitting multiple column
updates to rows at a time, isolation would ensure that a client would either see all of
updates made to that row or none of the updates (until they are all applied).</p>

<p>When using Isolation, there are additional concerns in iterator design. A scan time iterator in accumulo
reads from a set of data sources. While an iterator is reading data it has an isolated view. However, after it returns a
key/value it is possible that accumulo may switch data sources and re-seek the iterator. This is done so that resources
may be reclaimed. When the user does not request isolation this can occur after any key is returned. When a user enables
Isolation, this will only occur after a new row is returned, in which case it will re-seek to the very beginning of the
next possible row.</p>

<h2 id="abstract-iterators">Abstract Iterators</h2>

<p>A number of Abstract implementations of Iterators are provided to allow for faster creation
of common patterns. The most commonly used abstract implementations are the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Filter.html">Filter</a> and
<a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> classes. When possible these classes should be used instead as they have been
thoroughly tested inside Accumulo itself.</p>

<h3 id="filter">Filter</h3>

<p>The <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Filter.html">Filter</a> abstract Iterator provides a very simple implementation which allows implementations
to define whether or not a Key-Value pair should be returned via an <code class="language-plaintext highlighter-rouge">accept(Key, Value)</code> method.</p>

<p>Filters are extremely simple to implement; however, when the implementation is filtering a
large percentage of Key-Value pairs with respect to the total number of pairs examined,
it can be very inefficient. For example, if a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Filter.html">Filter</a> implementation can determine after examining
part of the row that no other pairs in this row will be accepted, there is no mechanism to
efficiently skip the remaining Key-Value pairs. Concretely, take a row which is comprised of
1000 Key-Value pairs. After examining the first 10 Key-Value pairs, it is determined
that no other Key-Value pairs in this row will be accepted. The Filter must still examine each
remaining 990 Key-Value pairs in this row. Another way to express this deficiency is that
Filters have no means to leverage the <code class="language-plaintext highlighter-rouge">seek</code> method to efficiently skip large portions
of Key-Value pairs.</p>

<p>As such, the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Filter.html">Filter</a> class functions well for filtering small amounts of data, but is
inefficient for filtering large amounts of data. The decision to use a Filter strongly
depends on the use case and distribution of data being filtered.</p>

<h3 id="combiner">Combiner</h3>

<p>The <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> class is another common abstract Iterator. Similar to the <code class="language-plaintext highlighter-rouge">Combiner</code> interface
define in Hadoop’s MapReduce framework, implementations of this abstract class reduce
multiple Values for different versions of a Key (Keys which only differ by timestamps) into one Key-Value pair.
Combiners provide a simple way to implement common operations like summation and
aggregation without the need to implement the entire Accumulo Iterator interface.</p>

<p>One important consideration when choosing to design a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> is that the “reduction” operation
is often best represented when it is associative and commutative. Operations which do not meet
these criteria can be implemented; however, the implementation can be difficult.</p>

<p>A second consideration is that a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> is not guaranteed to see every Key-Value pair
which differ only by timestamp every time it is invoked. For example, if there are 5 Key-Value
pairs in a table which only differ by the timestamps 1, 2, 3, 4, and 5, it is not guaranteed that
every invocation of the Combiner will see 5 timestamps. One invocation might see the Values for
Keys with timestamp 1 and 4, while another invocation might see the Values for Keys with the
timestamps 1, 2, 4 and 5.</p>

<p>Finally, when configuring an Accumulo table to use a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a>, be sure to disable the Versioning Iterator or set the
Combiner at a priority less than the Combiner (the Versioning Iterator is added at a priority of 20 by default). The
Versioning Iterator will filter out multiple Key-Value pairs that differ only by timestamp and return only the Key-Value
pair that has the largest timestamp.</p>

<h4 id="combiner-applications">Combiner Applications</h4>

<p>Many applications can benefit from the ability to aggregate values across common
keys. This can be done via <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> iterators and is similar to the Reduce step in
MapReduce. This provides the ability to define online, incrementally updated
analytics without the overhead or latency associated with batch-oriented
MapReduce jobs.</p>

<p>All that is needed to aggregate values of a table is to identify the fields over which
values will be grouped, insert mutations with those fields as the key, and configure
the table with a combining iterator that supports the summarizing operation
desired.</p>

<p>The only restriction on a combining iterator is that the combiner developer
should not assume that all values for a given key have been seen, since new
mutations can be inserted at anytime. This precludes using the total number of
values in the aggregation such as when calculating an average, for example.</p>

<p>An interesting use of combining iterators within an Accumulo table is to store
feature vectors for use in machine learning algorithms. For example, many
algorithms such as k-means clustering, support vector machines, anomaly detection,
etc. use the concept of a feature vector and the calculation of distance metrics to
learn a particular model. The columns in an Accumulo table can be used to efficiently
store sparse features and their weights to be incrementally updated via the use of a
combining iterator.</p>

<h2 id="best-practices">Best practices</h2>

<p>Because of the flexibility that the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/SortedKeyValueIterator.html">SortedKeyValueIterator</a> interface provides, it doesn’t directly disallow
many implementations which are poor design decisions. The following are some common recommendations to
follow and pitfalls to avoid in Iterator implementations.</p>

<h4 id="avoid-special-logic-encoded-in-ranges">Avoid special logic encoded in Ranges</h4>

<p>Commonly, granular Ranges that a client passes to an Iterator from a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/Scanner.html">Scanner</a> or <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/BatchScanner.html">BatchScanner</a> are unmodified.
If a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> falls within the boundaries of a Tablet, an Iterator will often see that same Range in the
<code class="language-plaintext highlighter-rouge">seek</code> method. However, there is no guarantee that the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> will remain unaltered from client to server. As such, Iterators
should <em>never</em> make assumptions about the current state/context based on the Range.</p>

<p>The common failure condition is referred to as a “re-seek”. In the context of a Scan, TabletServers construct the
“stack” of Iterators and batch up Key-Value pairs to send back to the client. When a sufficient number of Key-Value
pairs are collected, it is common for the Iterators to be “torn down” until the client asks for the next batch of
Key-Value pairs. This is done by the TabletServer to add fairness in ensuring one Scan does not monopolize the available
resources. When the client asks for the next batch, the implementation modifies the original Range so that servers know
the point to resume the iteration (to avoid returning duplicate Key-Value pairs). Specifically, the new Range is created
from the original but is shortened by setting the startKey of the original Range to the Key last returned by the Scan,
non-inclusive.</p>

<h3 id="seeking-backwards">seeking backwards</h3>

<p>The ability for an Iterator to “skip over” large blocks of Key-Value pairs is a major tenet behind Iterators.
By <code class="language-plaintext highlighter-rouge">seek</code>‘ing when it is known that there is a collection of Key-Value pairs which can be ignored can
greatly increase the speed of a scan as many Key-Value pairs do not have to be deserialized and processed.</p>

<p>While the <code class="language-plaintext highlighter-rouge">seek</code> method provides the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> that should be used to <code class="language-plaintext highlighter-rouge">seek</code> the underlying source Iterator,
there is no guarantee that the implementing Iterator uses that Range to perform the <code class="language-plaintext highlighter-rouge">seek</code> on its
“source” Iterator. As such, it is possible to seek to any Range and the interface has no assertions
to prevent this from happening.</p>

<p>Since Iterators are allowed to <code class="language-plaintext highlighter-rouge">seek</code> to arbitrary Keys, it also allows Iterators to create infinite loops
inside Scans that will repeatedly read the same data without end. If an arbitrary <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> is constructed, it should
construct a completely new Range as it allows for bugs to be introduced which will break Accumulo.</p>

<p>Thus, <code class="language-plaintext highlighter-rouge">seek</code>’s should always be thought of as making “forward progress” in the view of the total iteration. The
<code class="language-plaintext highlighter-rouge">startKey</code> of a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/data/Range.html">Range</a> should always be greater than the current Key seen by the Iterator while the <code class="language-plaintext highlighter-rouge">endKey</code> of the
Range should always retain the original <code class="language-plaintext highlighter-rouge">endKey</code> (and <code class="language-plaintext highlighter-rouge">endKey</code> inclusivity) of the last Range seen by your
Iterator’s implementation of seek.</p>

<h3 id="take-caution-in-constructing-new-data-in-an-iterator">Take caution in constructing new data in an Iterator</h3>

<p>Implementations of Iterator might be tempted to open <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/BatchWriter.html">BatchWriters</a> inside of an Iterator as a means
to implement triggers for writing additional data outside of their client application. The lifecycle of an Iterator
is <em>not</em> managed in such a way that guarantees that this is safe nor efficient. Specifically, there
is no way to guarantee that the internal ThreadPool inside of the BatchWriter is closed (and the thread(s)
are reaped) without calling the close() method. <code class="language-plaintext highlighter-rouge">close</code>‘ing and recreating a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/client/BatchWriter.html">BatchWriter</a> after every
Key-Value pair is also prohibitively performance limiting to be considered an option.</p>

<p>The only safe way to generate additional data in an Iterator is to alter the current Key-Value pair.
For example, the <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/user/WholeRowIterator.html">WholeRowIterator</a> serializes the all of the Key-Values pairs that fall within each
row. A safe way to generate more data in an Iterator would be to construct an Iterator that is
“higher” (at a larger priority) than the WholeRowIterator, that is, the Iterator receives the Key-Value pairs which are
a serialization of many Key-Value pairs. The custom Iterator could deserialize the pairs, compute
some function, and add a new Key-Value pair to the original collection, re-serializing the collection
of Key-Value pairs back into a single Key-Value pair.</p>

<p>Any other situation is likely not guaranteed to ensure that the caller (a Scan or a Compaction) will
always see all intended data that is generated.</p>

<h2 id="final-things-to-remember">Final things to remember</h2>

<p>Some simple recommendations/points to keep in mind:</p>

<h3 id="method-call-order">Method call order</h3>

<p>On an instance of an Iterator: <code class="language-plaintext highlighter-rouge">init</code> is always called before <code class="language-plaintext highlighter-rouge">seek</code>, <code class="language-plaintext highlighter-rouge">seek</code> is always called before <code class="language-plaintext highlighter-rouge">hasTop</code>,
<code class="language-plaintext highlighter-rouge">getTopKey</code> and <code class="language-plaintext highlighter-rouge">getTopValue</code> will not be called if <code class="language-plaintext highlighter-rouge">hasTop</code> returns false.</p>

<h3 id="teardown">Teardown</h3>

<p>Instances of iterators may be torn down inside the server transparently. When a complex collection
of iterators is performing advanced functionality, they will not be torn down until a Key-Value pair
is returned out of the “stack” of iterators (and added into the batch of Key-Values to be returned
to the caller), or the iterator is yielded.</p>

<p>When an iterator is torn down, the entire stack is dropped and no state is preserved. Only the last
key returned (or the yielded position), original options, and seek range are retained. When the scan
is continued, the iterator stack is rebuilt and re-initialized using the original options. The stack
is then seeked with the original range, and the start key is replaced by the last key returned (or
the yielded position), non-inclusive.</p>

<h2 id="compaction-time-iterators">Compaction-time Iterators</h2>

<p>When Iterators are configured to run during compactions, at the <code class="language-plaintext highlighter-rouge">minc</code> or <code class="language-plaintext highlighter-rouge">majc</code> scope, these Iterators sometimes need
to make different assertions than those who only operate at scan time. Iterators won’t see the delete entries; however,
Iterators will not necessarily see all of the Key-Value pairs in ever invocation. Because compactions often do not rewrite
all files (only a subset of them), it is possible that the logic take this into consideration.</p>

<p>For example, a <a href="https://www.javadoc.io/static/org.apache.accumulo/accumulo-core/4.0.0-SNAPSHOT/org/apache/accumulo/core/iterators/Combiner.html">Combiner</a> that runs over data at during compactions, might not see all of the values for a given Key. The
Combiner must recognize this and not perform any function that would be incorrect due
to the missing values.</p>

<h2 id="testing">Testing</h2>

<p>The <a href="/docs/4.x/development/development_tools#iterator-test-harness">Iterator test harness</a> is generalized testing framework for Accumulo Iterators that can
identify common pitfalls in user-created Iterators.</p>


    <div class="row mt-4">
      <div class="col-md-12 d-flex justify-content-between">
        <strong>Find documentation for all releases in the <a href="/docs-archive">archive</strong>
        <a href="https://github.com/apache/accumulo-website/edit/main/_docs-4/development/iterators.md" role="button"><span class="fa-solid fa-pen-to-square"></span> <small>Edit this page</small></a>
      </div>
    </div>
  </div>
</div>

        </div>

        
<footer>

  <p><a href="https://www.apache.org/foundation/contributing"><img src="https://www.apache.org/images/SupportApache-small.png" alt="Support the ASF" id="asf-logo" height="100" /></a></p>

  <p>Copyright © 2011-2025 <a href="https://www.apache.org">The Apache Software Foundation</a>.
Licensed under the <a href="https://www.apache.org/licenses/">Apache License, Version 2.0</a>.</p>

  <p>Apache®, the names of Apache projects and their logos, and the multicolor feather
logo are registered trademarks or trademarks of The Apache Software Foundation
in the United States and/or other countries.</p>

</footer>


      </div>
    </div>
  </div>
</body>
</html>
